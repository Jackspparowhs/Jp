<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Learn Japanese â€” PirateRuler.com</title>
<meta name="description" content="Learn Japanese â€” Hiragana, Katakana, vocab & quizzes. One page, offline, private." />
<meta name="theme-color" content="#f7fbff" />
<link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect rx="14" width="64" height="64" fill="%236b7dff"/><text x="50%" y="50%" font-family="Inter,Arial,sans-serif" font-weight="800" font-size="26" text-anchor="middle" alignment-baseline="central" fill="white">PR</text></svg>'>
<style>
  :root{
    --bg:#f3f7fb; --card:#ffffff; --muted:#6b7480; --text:#0b2130;
    --accent-start:#6b7dff; --accent-end:#0bb3ff;
    --glass: rgba(11,17,28,0.04);
    --radius:14px;
    --shadow-lg: 0 18px 50px rgba(3,12,30,0.18), inset 0 1px 0 rgba(255,255,255,0.6);
    --shadow-sm: 0 8px 24px rgba(3,12,30,0.08);
  }
  /* themes */
  html.dark { --bg:#071225; --card:#061028; --muted:#98a7bf; --text:#e9f1ff; --glass: rgba(255,255,255,0.02); --accent-start:#5ab3ff; --accent-end:#6b7dff; }
  html.ocean { --bg:#e8f7fb; --card:#ffffff; --muted:#4f6b75; --text:#063242; --glass: rgba(6,50,66,0.03); --accent-start:#00c2d1; --accent-end:#2b9fff; }
  html.sunset { --bg:#fff6f8; --card:#fff; --muted:#7a6b77; --text:#2a1020; --glass: rgba(42,16,32,0.03); --accent-start:#ff7aa2; --accent-end:#ffb86b; }

  *{box-sizing:border-box}
  body{background:linear-gradient(180deg,var(--bg), #e9f6ff); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:var(--text); margin:0; -webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:14px auto;padding:14px}

  header.header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(107,125,255,0.06), rgba(11,179,255,0.02));box-shadow:var(--shadow-sm)}
  .brand{display:flex;gap:12px;align-items:center;min-width:0}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
  .title-strong{font-size:18px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .by{font-size:12px;color:var(--muted);margin-top:2px}
  .header-actions{display:flex;align-items:center;gap:8px}
  .btn{padding:8px 10px;border-radius:10px;border:none;cursor:pointer;font-weight:800;background:transparent}
  .btn.theme{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#fff;border-radius:999px;padding:8px 12px;position:relative;overflow:visible}
  /* glow animation for theme button */
  .btn.theme::after{
    content:'';position:absolute;inset:-4px;border-radius:999px;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));filter:blur(8px);opacity:0;transition:opacity .18s;
  }
  .btn.theme.glow::after{opacity:0.95; animation:glowPulse 2.8s infinite;}
  @keyframes glowPulse{0%{transform:scale(.98)}50%{transform:scale(1.03)}100%{transform:scale(.98)}}

  .hamb{width:46px;height:46px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(0,0,0,0.04)}
  .hero{margin-top:16px;padding:18px;border-radius:14px;background:var(--card);box-shadow:var(--shadow-lg);border:1px solid rgba(0,0,0,0.04)}
  .hero .title{font-size:22px;font-weight:900;margin:0}
  .hero .hint{color:var(--muted);margin-top:6px}

  .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;align-items:center}
  .input{flex:1;min-width:180px}
  input[type="text"], input[type="number"], select, .search{ width:100%;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-size:16px;background:var(--card);color:var(--text) }

  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} .sidebar{position:fixed;width:94vw} }

  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow-sm);border:1px solid rgba(0,0,0,0.04)}
  .kana-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  .kana-tile{padding:22px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent);text-align:center;cursor:pointer;box-shadow:var(--shadow-sm)}
  .kana-tile .jp{font-size:26px;font-weight:900}
  .kana-tile .rom{font-size:12px;color:var(--muted);margin-top:6px}

  .panel{display:flex;flex-direction:column;gap:12px}
  .muted{color:var(--muted)}
  .footer{margin-top:18px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.96));text-align:center;box-shadow:var(--shadow-lg);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .visit{padding:10px 18px;border-radius:999px;background:linear-gradient(90deg,#ff7aa2 0%, #6b7dff 100%);color:#fff;font-weight:800;text-decoration:none}

  /* sidebar */
  .sidebar{position:fixed;right:0;top:0;height:100vh;width:360px;background:var(--card);box-shadow:-40px 0 80px rgba(2,8,20,0.25);padding:18px;transform:translateX(110%);transition:transform .28s cubic-bezier(.2,.9,.3,1);border-left:1px solid rgba(0,0,0,0.04);z-index:999}
  .sidebar.open{transform:translateX(0)}
  .sidebar h3{margin:0 0 8px 0}
  .sidebar a{display:block;padding:8px;border-radius:8px;color:var(--text);text-decoration:none}
  .sidebar .muted{color:var(--muted);font-size:13px}

  /* quiz area */
  .quiz-card{display:flex;flex-direction:column;gap:10px}
  .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .choice{padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:var(--card);cursor:pointer;font-weight:700}
  .choice.correct{outline:3px solid rgba(0,200,120,0.12)}
  .choice.wrong{outline:3px solid rgba(255,80,80,0.12)}
  .small{font-size:13px;color:var(--muted)}

  /* search results & vocab list */
  .vocab-list{display:grid;gap:8px}
  .vocab-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)}
  .vocab-left{display:flex;gap:12px;align-items:center}
  .jp-large{font-size:20px;font-weight:900}
  .rom-small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <header class="header" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden="true">PR</div>
      <div>
        <div class="title-strong">Learn Japanese</div>
        <div class="by">by PirateRuler.com</div>
      </div>
    </div>

    <div class="header-actions" role="navigation">
      <div class="theme-select" id="themeSelectWrap" style="position:relative">
        <button id="themeBtn" class="btn theme glow" title="Theme">Ocean â–¾</button>
        <div id="themeList" style="display:none;position:absolute;right:0;top:48px;background:var(--card);border-radius:10px;padding:8px;box-shadow:var(--shadow-sm);z-index:1000;">
          <div class="theme-item" data-theme="light" style="padding:8px;cursor:pointer">Light</div>
          <div class="theme-item" data-theme="dark" style="padding:8px;cursor:pointer">Dark</div>
          <div class="theme-item" data-theme="ocean" style="padding:8px;cursor:pointer">Ocean</div>
          <div class="theme-item" data-theme="sunset" style="padding:8px;cursor:pointer">Sunset</div>
        </div>
      </div>
      <div id="hambBtn" class="hamb" title="Open menu" aria-controls="sidebar">â˜°</div>
    </div>
  </header>

  <section class="hero" aria-labelledby="heroTitle">
    <h1 id="heroTitle" class="title">Japanese Starter â€” Hiragana, Katakana, Vocab</h1>
    <div class="hint">Interactive charts, flashcards & quizzes â€” offline and private. Click kana to hear it (speech) â€” try the quiz for 100 questions.</div>
  </section>

  <div class="grid">
    <main>
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div style="flex:1">
            <div style="font-weight:900;font-size:18px">Kana Charts</div>
            <div class="small muted">Switch chart, search romaji or kana</div>
          </div>
          <div style="width:320px">
            <input id="searchInput" class="search" placeholder="Search romaji, kana, or english (e.g. 'ka' or 'water')" />
          </div>
        </div>

        <div style="height:12px"></div>

        <div id="chartArea">
          <div style="display:flex;gap:10px;margin-bottom:12px">
            <button id="btnHira" class="btn ghost">Hiragana</button>
            <button id="btnKata" class="btn ghost">Katakana</button>
            <button id="btnVocab" class="btn ghost">Vocab</button>
            <button id="btnQuiz" class="btn primary">Start 100 Q Quiz</button>
          </div>

          <div id="kanaGrid" class="kana-grid"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Vocabulary & Flashcards</div>
          <div class="small muted">Click word to hear pronunciation</div>
        </div>
        <div style="height:8px"></div>
        <div id="vocabList" class="vocab-list"></div>
      </div>

      <div id="quizPanel" class="card" style="margin-top:12px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Quiz â€” 100 Questions</div>
          <div class="small muted" id="quizProgress">0 / 100</div>
        </div>
        <div style="height:8px"></div>
        <div id="quizArea" class="quiz-card">
          <div id="quizQuestion" style="font-size:18px;font-weight:900">Question will appear here</div>
          <div id="quizPrompt" class="small muted">Prompt type</div>
          <div class="choices" id="quizChoices"></div>
          <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
            <button id="nextBtn" class="btn ghost" disabled>Next</button>
            <button id="restartBtn" class="btn ghost">Restart Quiz</button>
          </div>
        </div>
        <div style="height:8px"></div>
        <div id="quizResult" class="small muted"></div>
      </div>
    </main>

    <!-- RIGHT: feature panel & sidebar trigger -->
    <aside>
      <div class="card feature-panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Why this tool?</div>
          <div class="small muted">Offline â€¢ Private</div>
        </div>

        <div style="margin-top:12px" class="panel">
          <div class="small muted">Interactive kana with speech, vocabulary flashcards and a full 100-question quiz to practice. Everything runs client-sideâ€”no accounts required.</div>
          <div style="display:flex;gap:8px">
            <button id="openSidebar" class="btn ghost">Menu</button>
            <button id="downloadVocab" class="btn ghost">Download Vocab (.json)</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div style="font-weight:900">Quick actions</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <button id="jumpQuiz" class="btn ghost">Jump to Quiz</button>
          <button id="showAllV" class="btn ghost">Show all vocab</button>
          <button id="shuffleQuiz" class="btn ghost">Shuffle Quiz</button>
        </div>

        <div style="height:12px"></div>

        <div class="small muted">Tip: you can click any kana or vocab row to hear it (browser speech). Use the search to filter quickly.</div>
      </div>
    </aside>
  </div>

  <footer class="footer">
    <small class="muted">Â© <span id="year"></span> Learn Japanese â€” PirateRuler</small>
    <a class="visit" href="https://pirateruler.com" target="_blank" rel="noopener noreferrer">Visit PirateRuler.com</a>
  </footer>
</div>

<!-- Sidebar (same style as calculator) -->
<aside id="sidebar" class="sidebar" aria-hidden="true">
  <div style="display:flex;justify-content:flex-end"><button id="closeSidebar" class="btn ghost">Close</button></div>
  <h3>Learn Japanese</h3>
  <nav style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
    <a href="#" id="menuKana">Kana Charts</a>
    <a href="#" id="menuVocab">Vocabulary</a>
    <a href="#" id="menuQuiz">100 Q Quiz</a>
    <a href="https://pirateruler.com/post/about.html" target="_blank">About â€” PirateRuler</a>
    <a href="https://pirateruler.com/post/privacy.html" target="_blank">Privacy Policy</a>
    <a href="https://pirateruler.com/post/contact.html" target="_blank">Contact</a>
  </nav>
  <div style="margin-top:18px;color:var(--muted);font-size:13px">
    Offline resource â€” all data stored in the page.
  </div>
</aside>

<script>
/* --- data: kana & vocab --- */
/* Simple hiragana table (core 46) */
const HIRAGANA = [
  ['ã‚','a'],['ã„','i'],['ã†','u'],['ãˆ','e'],['ãŠ','o'],
  ['ã‹','ka'],['ã','ki'],['ã','ku'],['ã‘','ke'],['ã“','ko'],
  ['ã•','sa'],['ã—','shi'],['ã™','su'],['ã›','se'],['ã','so'],
  ['ãŸ','ta'],['ã¡','chi'],['ã¤','tsu'],['ã¦','te'],['ã¨','to'],
  ['ãª','na'],['ã«','ni'],['ã¬','nu'],['ã­','ne'],['ã®','no'],
  ['ã¯','ha'],['ã²','hi'],['ãµ','fu'],['ã¸','he'],['ã»','ho'],
  ['ã¾','ma'],['ã¿','mi'],['ã‚€','mu'],['ã‚','me'],['ã‚‚','mo'],
  ['ã‚„','ya'],['ã‚†','yu'],['ã‚ˆ','yo'],
  ['ã‚‰','ra'],['ã‚Š','ri'],['ã‚‹','ru'],['ã‚Œ','re'],['ã‚','ro'],
  ['ã‚','wa'],['ã‚’','wo'],['ã‚“','n']
];
/* Katakana: same set as romaji but different chars (small sample) */
const KATAKANA = [
  ['ã‚¢','a'],['ã‚¤','i'],['ã‚¦','u'],['ã‚¨','e'],['ã‚ª','o'],
  ['ã‚«','ka'],['ã‚­','ki'],['ã‚¯','ku'],['ã‚±','ke'],['ã‚³','ko'],
  ['ã‚µ','sa'],['ã‚·','shi'],['ã‚¹','su'],['ã‚»','se'],['ã‚½','so'],
  ['ã‚¿','ta'],['ãƒ','chi'],['ãƒ„','tsu'],['ãƒ†','te'],['ãƒˆ','to'],
  ['ãƒŠ','na'],['ãƒ‹','ni'],['ãƒŒ','nu'],['ãƒ','ne'],['ãƒŽ','no'],
  ['ãƒ','ha'],['ãƒ’','hi'],['ãƒ•','fu'],['ãƒ˜','he'],['ãƒ›','ho'],
  ['ãƒž','ma'],['ãƒŸ','mi'],['ãƒ ','mu'],['ãƒ¡','me'],['ãƒ¢','mo'],
  ['ãƒ¤','ya'],['ãƒ¦','yu'],['ãƒ¨','yo'],
  ['ãƒ©','ra'],['ãƒª','ri'],['ãƒ«','ru'],['ãƒ¬','re'],['ãƒ­','ro'],
  ['ãƒ¯','wa'],['ãƒ²','wo'],['ãƒ³','n']
];

/* VOCAB: 100 common words (romaji, kana, english) â€” editable */
const VOCAB = [
  {r:'konnichiwa', jp:'ã“ã‚“ã«ã¡ã¯', en:'Hello'},
  {r:'ohayou', jp:'ãŠã¯ã‚ˆã†', en:'Good morning'},
  {r:'oyasumi', jp:'ãŠã‚„ã™ã¿', en:'Good night'},
  {r:'arigatou', jp:'ã‚ã‚ŠãŒã¨ã†', en:'Thank you'},
  {r:'sumimasen', jp:'ã™ã¿ã¾ã›ã‚“', en:'Excuse me / Sorry'},
  {r:'hai', jp:'ã¯ã„', en:'Yes'},
  {r:'iie', jp:'ã„ã„ãˆ', en:'No'},
  {r:'onegai', jp:'ãŠé¡˜ã„ã—ã¾ã™', en:'Please'},
  {r:'gomen', jp:'ã”ã‚ã‚“', en:'Sorry'},
  {r:'daijoubu', jp:'å¤§ä¸ˆå¤«', en:'It\'s OK'},
  {r:'taberu', jp:'é£Ÿã¹ã‚‹', en:'To eat'},
  {r:'nomu', jp:'é£²ã‚€', en:'To drink'},
  {r:'miru', jp:'è¦‹ã‚‹', en:'To see/watch'},
  {r:'kiku', jp:'èžã', en:'To listen'},
  {r:'yomu', jp:'èª­ã‚€', en:'To read'},
  {r:'kaku', jp:'æ›¸ã', en:'To write'},
  {r:'hanasu', jp:'è©±ã™', en:'To speak'},
  {r:'wakaru', jp:'åˆ†ã‹ã‚‹', en:'To understand'},
  {r:'wakarimasen', jp:'åˆ†ã‹ã‚Šã¾ã›ã‚“', en:'I don\'t understand'},
  {r:'namae', jp:'åå‰', en:'Name'},
  {r:'watashi', jp:'ç§', en:'I / me'},
  {r:'anata', jp:'ã‚ãªãŸ', en:'You'},
  {r:'tomodachi', jp:'å‹é”', en:'Friend'},
  {r:'kazoku', jp:'å®¶æ—', en:'Family'},
  {r:'kare', jp:'å½¼', en:'He / boyfriend'},
  {r:'kanojo', jp:'å½¼å¥³', en:'She / girlfriend'},
  {r:'aisuru', jp:'æ„›ã™ã‚‹', en:'To love'},
  {r:'suimasen', jp:'ã™ã„ã¾ã›ã‚“', en:'Excuse me (alt)'},
  {r:'iku', jp:'è¡Œã', en:'To go'},
  {r:'kuru', jp:'æ¥ã‚‹', en:'To come'},
  {r:'kaeru', jp:'å¸°ã‚‹', en:'To return'},
  {r:'hashiru', jp:'èµ°ã‚‹', en:'To run'},
  {r:'aruku', jp:'æ­©ã', en:'To walk'},
  {r:'shiru', jp:'çŸ¥ã‚‹', en:'To know'},
  {r:'hoshii', jp:'æ¬²ã—ã„', en:'Want'},
  {r:'takai', jp:'é«˜ã„', en:'Expensive / tall'},
  {r:'yasui', jp:'å®‰ã„', en:'Cheap'},
  {r:'ookii', jp:'å¤§ãã„', en:'Big'},
  {r:'chiisai', jp:'å°ã•ã„', en:'Small'},
  {r:'atsui', jp:'æš‘ã„', en:'Hot (weather)'},
  {r:'samui', jp:'å¯’ã„', en:'Cold (weather)'},
  {r:'atsui2', jp:'ç†±ã„', en:'Hot (object)'},
  {r:'samui2', jp:'å†·ãŸã„', en:'Cold (object)'},
  {r:'oishii', jp:'ãŠã„ã—ã„', en:'Delicious'},
  {r:'ã¾ãšã„', jp:'ã¾ãšã„', en:'Bad taste'},
  {r:'mizu', jp:'æ°´', en:'Water'},
  {r:'tabemono', jp:'é£Ÿã¹ç‰©', en:'Food'},
  {r:'gohan', jp:'ã”é£¯', en:'Rice/meal'},
  {r:'nani', jp:'ä½•', en:'What'},
  {r:'doko', jp:'ã©ã“', en:'Where'},
  {r:'itsu', jp:'ã„ã¤', en:'When'},
  {r:'dare', jp:'èª°', en:'Who'},
  {r:'naze', jp:'ä½•æ•…', en:'Why'},
  {r:'dou', jp:'ã©ã†', en:'How'},
  {r:'toire', jp:'ãƒˆã‚¤ãƒ¬', en:'Toilet'},
  {r:'eki', jp:'é§…', en:'Station'},
  {r:'densha', jp:'é›»è»Š', en:'Train'},
  {r:'basu', jp:'ãƒã‚¹', en:'Bus'},
  {r:'kuko', jp:'ç©ºæ¸¯', en:'Airport'},
  {r:'hoteru', jp:'ãƒ›ãƒ†ãƒ«', en:'Hotel'},
  {r:'furo', jp:'é¢¨å‘‚', en:'Bath'},
  {r:'heya', jp:'éƒ¨å±‹', en:'Room'},
  {r:'michi', jp:'é“', en:'Road'},
  {r:'hidari', jp:'å·¦', en:'Left'},
  {r:'migi', jp:'å³', en:'Right'},
  {r:'massugu', jp:'çœŸã£ç›´ã', en:'Straight'},
  {r:'tomete', jp:'æ­¢ã‚ã¦', en:'Stop'},
  {r:'kiite', jp:'èžã„ã¦', en:'Listen (imperative)'},
  {r:'tetsudatte', jp:'æ‰‹ä¼ã£ã¦', en:'Help me'},
  {r:'kiken', jp:'å±é™º', en:'Danger'},
  {r:'keisatsu', jp:'è­¦å¯Ÿ', en:'Police'},
  {r:'byouin', jp:'ç—…é™¢', en:'Hospital'},
  {r:'isha', jp:'åŒ»è€…', en:'Doctor'},
  {r:'yakkyoku', jp:'è–¬å±€', en:'Pharmacy'},
  {r:'shiken', jp:'è©¦é¨“', en:'Exam'},
  {r:'chotto', jp:'ã¡ã‚‡ã£ã¨', en:'A little / excuse me'},
  {r:'kudasai', jp:'ãã ã•ã„', en:'Please (give me)'},
  {r:'douzo', jp:'ã©ã†ãž', en:'Here you go'},
  {r:'yoroshiku', jp:'ã‚ˆã‚ã—ã', en:'Nice to meet you / please treat me well'},
  {r:'omedetou', jp:'ãŠã‚ã§ã¨ã†', en:'Congratulations'},
  {r:'ganbatte', jp:'é ‘å¼µã£ã¦', en:'Good luck / do your best'},
  {r:'ureshii', jp:'å¬‰ã—ã„', en:'Happy'},
  {r:'kanashii', jp:'æ‚²ã—ã„', en:'Sad'},
  {r:'kowai', jp:'æ€–ã„', en:'Scary'},
  {r:'kirei', jp:'ç¶ºéº—', en:'Beautiful/clean'},
  {r:'yama', jp:'å±±', en:'Mountain'},
  {r:'umi', jp:'æµ·', en:'Sea'},
  {r:'kawa', jp:'å·', en:'River'},
  {r:'shiro', jp:'åŸŽ', en:'Castle'},
  {r:'machi', jp:'ç”º', en:'Town / city'},
  {r:'kuni', jp:'å›½', en:'Country'},
  {r:'denwa', jp:'é›»è©±', en:'Phone'},
  {r:'pasokon', jp:'ãƒ‘ã‚½ã‚³ãƒ³', en:'Computer / PC'},
  {r:'netto', jp:'ãƒãƒƒãƒˆ', en:'Internet'},
  {r:'okane', jp:'ãŠé‡‘', en:'Money'},
  {r:'ryokou', jp:'æ—…è¡Œ', en:'Trip / travel'},
  {r:'shigoto', jp:'ä»•äº‹', en:'Work / job'},
];

/* --- helpers & UI wiring --- */
const el = id => document.getElementById(id);
el('year').textContent = new Date().getFullYear();

// theme handling
const root = document.documentElement, themeBtn = el('themeBtn'), themeList = document.getElementById('themeList');
function applyTheme(t){
  ['dark','ocean','sunset'].forEach(c=> root.classList.remove(c));
  if(t==='dark'){ root.classList.add('dark'); themeBtn.textContent='Dark â–¾'; localStorage.setItem('pr-theme','dark'); }
  else if(t==='ocean'){ root.classList.add('ocean'); themeBtn.textContent='Ocean â–¾'; localStorage.setItem('pr-theme','ocean'); }
  else if(t==='sunset'){ root.classList.add('sunset'); themeBtn.textContent='Sunset â–¾'; localStorage.setItem('pr-theme','sunset'); }
  else { themeBtn.textContent='Light â–¾'; localStorage.setItem('pr-theme','light'); }
  // glow when non-light
  themeBtn.classList.toggle('glow', t !== 'light');
}
const saved = localStorage.getItem('pr-theme') || 'ocean';
applyTheme(saved);
themeBtn.addEventListener('click', ()=> { themeList.style.display = themeList.style.display === 'block' ? 'none' : 'block'; });
themeList.addEventListener('click', e => { const t=e.target.closest('.theme-item'); if(!t) return; applyTheme(t.dataset.theme); themeList.style.display='none';});
document.addEventListener('click', (e)=> { if(!document.getElementById('themeSelectWrap')?.contains(e.target)) themeList.style.display='none'; });

// sidebar
const sidebar = el('sidebar'), hambBtn = el('hambBtn'), closeSidebar = el('closeSidebar'), openSidebarBtn = el('openSidebar');
hambBtn.addEventListener('click', ()=> { sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); });
closeSidebar.addEventListener('click', ()=> { sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); });
openSidebarBtn.addEventListener('click', ()=> { sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); });

// main UI pieces
const kanaGrid = el('kanaGrid'), searchInput = el('searchInput'), vocabList = el('vocabList');
const btnHira = el('btnHira'), btnKata = el('btnKata'), btnVocab = el('btnVocab'), btnQuiz = el('btnQuiz');

// state
let currentView = 'hiragana'; // hiragana | katakana | vocab
let currentKana = HIRAGANA.slice();
let currentVocab = VOCAB.slice();
let filteredVocab = currentVocab.slice();

// render helpers
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = 'ja-JP';
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(msg);
}

function renderKana(list){
  kanaGrid.innerHTML='';
  for(const [char,rom] of list){
    const tile = document.createElement('div'); tile.className='kana-tile';
    tile.innerHTML = `<div class="jp">${char}</div><div class="rom">${rom}</div>`;
    tile.addEventListener('click', ()=> { speak(rom); tile.animate([{transform:'scale(1)'},{transform:'scale(0.96)'},{transform:'scale(1)'}],{duration:220}); });
    kanaGrid.appendChild(tile);
  }
}

function renderVocab(list, limit=50){
  vocabList.innerHTML='';
  const toShow = list.slice(0, limit);
  for(const w of toShow){
    const row = document.createElement('div'); row.className='vocab-row';
    row.innerHTML = `<div class="vocab-left"><div class="jp-large">${w.jp}</div><div class="rom-small">${w.r} â€” ${w.en}</div></div><div class="small muted">ðŸ”Š</div>`;
    row.addEventListener('click', ()=> { speak(w.r); });
    vocabList.appendChild(row);
  }
  if(list.length > limit){
    const more = document.createElement('button'); more.className='btn ghost'; more.textContent='Show all'; more.addEventListener('click', ()=> renderVocab(list, list.length));
    vocabList.appendChild(more);
  }
}

// initial view
renderKana(currentKana);

// controls
btnHira.addEventListener('click', ()=> { currentView='hiragana'; currentKana = HIRAGANA.slice(); renderKana(currentKana); });
btnKata.addEventListener('click', ()=> { currentView='katakana'; currentKana = KATAKANA.slice(); renderKana(currentKana); });
btnVocab.addEventListener('click', ()=> { currentView='vocab'; renderVocab(currentVocab, 50); });
btnQuiz.addEventListener('click', ()=> { startQuiz(); });

// search
searchInput.addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q){
    if(currentView==='hiragana' || currentView==='katakana') renderKana(currentKana);
    else renderVocab(currentVocab,50);
    return;
  }
  // search kana (by romaji) and vocab by romaji/kana/english
  const filteredKana = currentKana.filter(([ch,rom]) => rom.includes(q) || ch.includes(q));
  const filtered = currentVocab.filter(w => w.r.toLowerCase().includes(q) || w.jp.includes(q) || w.en.toLowerCase().includes(q));
  if(currentView==='hiragana' || currentView==='katakana') renderKana(filteredKana.length ? filteredKana : currentKana.filter(([ch,rom]) => rom.includes(q) || ch.includes(q)));
  else renderVocab(filtered, 200);
});

// menu links in sidebar
document.getElementById('menuKana').addEventListener('click', ()=> { sidebar.classList.remove('open'); currentView='hiragana'; renderKana(HIRAGANA); window.scrollTo({top:0,behavior:'smooth'}); });
document.getElementById('menuVocab').addEventListener('click', ()=> { sidebar.classList.remove('open'); currentView='vocab'; renderVocab(currentVocab,50); window.scrollTo({top:0,behavior:'smooth'}); });
document.getElementById('menuQuiz').addEventListener('click', ()=> { sidebar.classList.remove('open'); startQuiz(); window.scrollTo({top:0,behavior:'smooth'}); });

// download vocab json
el('downloadVocab').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(VOCAB,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'jp-vocab.json'; a.click(); URL.revokeObjectURL(a.href);
});

// quick actions
el('jumpQuiz').addEventListener('click', startQuiz);
el('showAllV').addEventListener('click', ()=> { currentView='vocab'; renderVocab(currentVocab, currentVocab.length); window.scrollTo({top:0,behavior:'smooth'}); });
el('shuffleQuiz').addEventListener('click', ()=> { shuffleArray(QUIZPOOL); alert('Quiz order shuffled'); });

// ---------------- Quiz logic ----------------
const quizPanel = el('quizPanel'), quizProgress = el('quizProgress'), quizQuestion = el('quizQuestion'), quizPrompt = el('quizPrompt');
const quizChoices = el('quizChoices'), nextBtn = el('nextBtn'), restartBtn = el('restartBtn'), quizResult = el('quizResult');

let QUIZPOOL = []; // will be filled with 100 items
let QUIZIDX = 0, SCORE = 0, CURRENT_Q = null;

function shuffleArray(arr){
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
}

function buildQuizPool(){
  // Ensure at least 100 items: if VOCAB length < 100, repeat with slight variations; else pick 100
  const pool = [];
  // prefer unique vocab
  for(const v of VOCAB) pool.push(v);
  while(pool.length < 100){ pool.push(...VOCAB.slice(0, Math.min(VOCAB.length, 100-pool.length))); }
  // trim to 100
  const trimmed = pool.slice(0,100).map(item => ({...item}));
  shuffleArray(trimmed);
  QUIZPOOL = trimmed;
}

function startQuiz(){
  buildQuizPool();
  QUIZIDX = 0; SCORE = 0; quizPanel.style.display='block'; el('quizResult').textContent=''; nextBtn.disabled = true;
  showQuestion();
}

function showQuestion(){
  if(QUIZIDX >= QUIZPOOL.length){
    // finished
    quizQuestion.textContent = 'Quiz complete';
    quizPrompt.textContent = `Score: ${SCORE} / ${QUIZPOOL.length}`;
    quizChoices.innerHTML = '';
    quizProgress.textContent = `${QUIZIDX} / ${QUIZPOOL.length}`;
    quizResult.textContent = 'You finished the 100-question quiz. Restart to play again.';
    return;
  }
  CURRENT_Q = QUIZPOOL[QUIZIDX];
  quizProgress.textContent = `${QUIZIDX+1} / ${QUIZPOOL.length}`;
  // ask English -> select romaji (or kana)
  quizQuestion.textContent = `${CURRENT_Q.en}`;
  quizPrompt.textContent = `Choose the correct Japanese (romaji shown)`;
  // build choices: correct + 3 random romaji
  const choices = [CURRENT_Q.r];
  while(choices.length < 4){
    const cand = VOCAB[Math.floor(Math.random()*VOCAB.length)].r;
    if(!choices.includes(cand)) choices.push(cand);
  }
  shuffleArray(choices);
  quizChoices.innerHTML = '';
  for(const c of choices){
    const btn = document.createElement('button'); btn.className='choice'; btn.textContent=c;
    btn.addEventListener('click', ()=> handleChoice(btn, c));
    quizChoices.appendChild(btn);
  }
  nextBtn.disabled = true;
  quizResult.textContent = '';
}

function handleChoice(button, choice){
  // disable all
  Array.from(quizChoices.children).forEach(b=>b.disabled=true);
  if(choice === CURRENT_Q.r){
    button.classList.add('correct');
    SCORE++;
    quizResult.textContent = 'Correct âœ“';
  } else {
    button.classList.add('wrong');
    // highlight correct
    Array.from(quizChoices.children).forEach(b=>{ if(b.textContent === CURRENT_Q.r) b.classList.add('correct'); });
    quizResult.textContent = `Wrong â€” correct answer: ${CURRENT_Q.r} (${CURRENT_Q.jp})`;
  }
  nextBtn.disabled = false;
}

// next and restart
nextBtn.addEventListener('click', ()=>{
  QUIZIDX++; showQuestion();
});
restartBtn.addEventListener('click', ()=> { buildQuizPool(); QUIZIDX=0; SCORE=0; showQuestion(); });

// init quiz pool for quick start
buildQuizPool();

// utility: show vocab on load
renderVocab(currentVocab, 50);

</script>
</body>
</html>
