<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Learn Japanese â€” PirateRuler.com</title>
<meta name="description" content="Learn Japanese (Hiragana, Katakana, Vocab). Offline, one page. By PirateRuler." />
<style>
  :root{
    --bg:#f3f7fb; --card:#fff; --muted:#6b7480; --text:#072028;
    --accent-start:#6b7dff; --accent-end:#0bb3ff; --glass: rgba(11,17,28,0.04);
    --radius:14px; --shadow-sm: 0 8px 24px rgba(3,12,30,0.08);
  }
  html.dark { --bg:#071225; --card:#061028; --muted:#98a7bf; --text:#e9f1ff; --glass: rgba(255,255,255,0.02); --accent-start:#5ab3ff; --accent-end:#6b7dff; --shadow-sm: 0 8px 24px rgba(0,0,0,0.45); }
  html.ocean { --bg:#e8f7fb; --card:#ffffff; --muted:#4f6b75; --text:#063242; --accent-start:#00c2d1; --accent-end:#2b9fff; }
  html.sunset { --bg:#fff6f8; --card:#fff; --muted:#7a6b77; --text:#2a1020; --accent-start:#ff7aa2; --accent-end:#ffb86b; }

  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:linear-gradient(180deg,var(--bg), #eaf7ff);color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .container{max-width:1100px;margin:12px auto;padding:14px}

  /* Header */
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:14px;background:linear-gradient(90deg, rgba(107,125,255,0.06), rgba(11,179,255,0.02));box-shadow:var(--shadow-sm)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:20px}
  .brand-title .title{font-weight:900;font-size:18px;margin:0}
  .brand-title .by{font-size:12px;color:var(--muted);margin-top:2px}

  .header-actions{display:flex;gap:10px;align-items:center}
  .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
  .btn.theme{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;border:0} /* no glow */

  .hamb{width:46px;height:46px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(0,0,0,0.04)}

  /* Hero */
  .hero{margin-top:14px;padding:20px;border-radius:14px;background:var(--card);box-shadow:var(--shadow-sm)}
  .hero .big{font-size:24px;font-weight:900;margin:0}
  .hero .small{color:var(--muted);margin-top:6px}

  /* grid */
  .grid {display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-top:14px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}

  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow-sm);border:1px solid rgba(0,0,0,0.04)}
  .hint{color:var(--muted);font-size:13px;margin-bottom:8px}

  input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(10,20,40,0.06);font-size:15px;background:transparent;color:var(--text)}

  /* kana grid */
  .kana-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:12px}
  @media(max-width:600px){.kana-grid{grid-template-columns:repeat(5,1fr)}}
  .kana{background:linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));border-radius:12px;padding:18px;text-align:center;cursor:pointer;border:1px solid rgba(0,0,0,0.04)}
  .kana .char{font-size:28px;font-weight:800}
  .kana .rom{font-size:13px;color:var(--muted);margin-top:6px}

  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
  .linkish{color:var(--accent-start);font-weight:800;cursor:pointer;font-size:14px}

  /* feature panel / sidebar (right) */
  aside{align-self:start}
  .feature-panel{position:sticky;top:18px;padding:12px;border-radius:12px;background:var(--card);box-shadow:var(--shadow-sm)}
  .features{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:700px){.features{grid-template-columns:1fr}}

  .feature{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.98));display:flex;gap:12px;align-items:center}
  .f-icon{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}

  /* quiz */
  .quiz-area{margin-top:12px}
  .question{font-weight:900;font-size:20px;margin-bottom:12px}
  .choices{display:grid;gap:8px}
  .choice{padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.02));font-weight:700}
  .choice.correct{border-color:green;color:green}
  .choice.wrong{border-color:#cc3a3a;color:#cc3a3a}

  /* footer */
  footer{margin-top:16px;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.96));text-align:center;box-shadow:var(--shadow-sm)}
  .visit{padding:10px 18px;border-radius:999px;background:linear-gradient(90deg,#ff7aa2 0%, #6b7dff 100%);color:white;font-weight:800;text-decoration:none;display:inline-block}
  .muted{color:var(--muted);font-size:13px}

  /* sidebar panel (offcanvas) */
  .sidebar{position:fixed;top:0;right:0;height:100vh;width:360px;max-width:94vw;transform:translateX(120%);transition:transform .28s cubic-bezier(.2,.9,.3,1);z-index:999;background:var(--card);box-shadow:-40px 0 80px rgba(2,8,20,0.25);padding:20px;border-left:1px solid rgba(0,0,0,0.04)}
  .sidebar.open{transform:translateX(0)}
  .sidebar .nav-list{display:flex;flex-direction:column;gap:12px;margin-top:8px}
  .sidebar a{display:block;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.02));font-weight:700;color:var(--text)}

  /* small helpers */
  .row{display:flex;gap:8px}
  .center{text-align:center}
  .small-muted{font-size:12px;color:var(--muted)}

</style>
</head>
<body>
<div class="container">

  <!-- header -->
  <header class="header" role="banner">
    <div class="brand">
      <div class="logo">PR</div>
      <div class="brand-title">
        <div class="title">Learn Japanese</div>
        <div class="by">by PirateRuler.com</div>
      </div>
    </div>

    <div class="header-actions" role="navigation">
      <div class="theme-select" id="themeSelectWrap" style="position:relative">
        <button id="themeBtn" class="btn theme" title="Theme">Ocean â–¾</button>
        <div id="themeList" style="display:none;position:absolute;right:0;top:46px;background:var(--card);padding:8px;border-radius:8px;box-shadow:var(--shadow-sm)">
          <div class="theme-item" data-theme="light" style="padding:8px;cursor:pointer">Light</div>
          <div class="theme-item" data-theme="dark" style="padding:8px;cursor:pointer">Dark</div>
          <div class="theme-item" data-theme="ocean" style="padding:8px;cursor:pointer">Ocean</div>
          <div class="theme-item" data-theme="sunset" style="padding:8px;cursor:pointer">Sunset</div>
        </div>
      </div>

      <div class="hamb" id="hambBtn" title="Open menu" aria-controls="sidebar">â˜°</div>
    </div>
  </header>

  <!-- hero -->
  <section class="hero" aria-labelledby="heroTitle">
    <h1 id="heroTitle" class="big">Japanese Starter â€” Hiragana, Katakana, Vocab</h1>
    <p class="small">Interactive charts, flashcards & quizzes â€” offline and private. Click kana to hear it. Try the 100-question quiz to test yourself.</p>
  </section>

  <!-- main -->
  <main class="grid" role="main">
    <div>
      <!-- kana + search -->
      <section class="card" aria-labelledby="kanaTitle">
        <h2 id="kanaTitle">Kana Charts</h2>
        <div class="hint">Switch chart, search romaji, kana or English</div>

        <div class="controls">
          <div class="row" role="tablist" aria-label="Chart switch">
            <button class="btn ghost" id="btnHira">Hiragana</button>
            <button class="btn ghost" id="btnKata">Katakana</button>
            <button class="btn ghost" id="btnVocab">Vocab</button>
            <button class="btn ghost" id="btnQuiz">Start 100 Q Quiz</button>
          </div>
          <div style="flex:1"></div>
          <div style="width:260px"><input id="search" type="text" placeholder="Search romaji, kana, or english (e.g. 'ka' or 'water')" /></div>
        </div>

        <div id="chartsWrap">
          <div id="kanaGrid" class="kana-grid" aria-live="polite"></div>
        </div>
      </section>

      <!-- vocab / flashcards -->
      <section id="vocabCard" class="card" style="margin-top:12px;display:none">
        <h2>Vocabulary</h2>
        <div class="hint">Click a vocab card to hear the Japanese. Use search to filter.</div>
        <div id="vocabList" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px"></div>
      </section>

      <!-- quiz -->
      <section id="quizCard" class="card" style="margin-top:12px;display:none">
        <h2>100 Question Quiz</h2>
        <div class="hint">Multiple choice â€” progress and score shown.</div>
        <div id="quizArea" class="quiz-area">
          <div id="quizIntro">
            <p class="small-muted">You will get 100 questions drawn from the vocab list. Each question shows a Japanese word; pick the correct English meaning.</p>
            <div class="row" style="margin-top:8px">
              <button id="startQuiz" class="btn theme">Start Quiz (100)</button>
              <button id="cancelQuiz" class="btn ghost">Cancel</button>
            </div>
          </div>

          <div id="quizUI" style="display:none">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="small-muted" id="qProgress">Q 0 / 100</div>
              <div class="small-muted" id="qScore">Score: 0</div>
            </div>
            <div id="questionBox" style="margin-top:10px">
              <div class="question" id="questionText"></div>
              <div class="choices" id="choicesWrap"></div>
            </div>
            <div style="margin-top:12px" class="row">
              <button id="nextQ" class="btn theme" style="display:none">Next</button>
              <button id="endQuiz" class="btn ghost">End Quiz</button>
            </div>
          </div>

          <div id="quizSummary" style="display:none;margin-top:12px"></div>
        </div>
      </section>
    </div>

    <!-- right features / panel -->
    <aside>
      <div class="feature-panel">
        <div class="panel-title" style="font-weight:900">Why this app?</div>
        <div class="features">
          <div class="feature"><div class="f-icon">ðŸ”’</div><div><div style="font-weight:800">Private</div><div class="f-desc small-muted">All data runs in your browser â€” no servers or APIs.</div></div></div>
          <div class="feature"><div class="f-icon">âš¡</div><div><div style="font-weight:800">Offline</div><div class="f-desc small-muted">Works from a single HTML file.</div></div></div>
          <div class="feature"><div class="f-icon">ðŸ§ </div><div><div style="font-weight:800">Practice</div><div class="f-desc small-muted">Charts, flashcards and a 100-question quiz.</div></div></div>
          <div class="feature"><div class="f-icon">ðŸŽ§</div><div><div style="font-weight:800">Audio</div><div class="f-desc small-muted">Click kana/vocab to hear pronunciation (browser speech).</div></div></div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:900;margin-bottom:6px">Quick actions</div>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button id="jumpTop" class="btn ghost">Jump to Top</button>
            <button id="showVocab" class="btn ghost">Show Vocab</button>
            <button id="showQuiz" class="btn ghost">Open Quiz</button>
          </div>
        </div>

        <div style="margin-top:12px" class="small-muted">Tip: click any kana or vocab card to hear it.</div>
      </div>
    </aside>
  </main>

  <!-- footer -->
  <footer>
    <a class="visit" href="https://pirateruler.com" target="_blank" rel="noopener noreferrer">Visit PirateRuler.com</a>
    <div style="height:10px"></div>
    <small class="muted">Â© <span id="year"></span> Learn Japanese â€” PirateRuler.com</small>
  </footer>

  <!-- sidebar offcanvas -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <div style="display:flex;justify-content:flex-end"><button id="closeSidebar" class="btn ghost">Close</button></div>
    <h3 style="margin-top:6px">PirateRuler Links</h3>
    <p class="small-muted">Quick links & backup resources</p>
    <div class="nav-list">
      <a href="https://pirateruler.com/post/about.html" target="_blank">About â€” PirateRuler</a>
      <a href="https://pirateruler.com/post/privacy.html" target="_blank">Privacy Policy</a>
      <a href="https://pirateruler.com/post/contact.html" target="_blank">Contact</a>
      <a href="https://pirateruler.com/post/terms.html" target="_blank">Terms & Service</a>
    </div>
    <div style="margin-top:18px" class="small-muted">Backup & resources:<br><a href="https://pirateruler.com" target="_blank">pirateruler.com</a></div>
  </aside>

</div>

<script>
/* ---------- static data: kana and vocab ---------- */

/* Basic hiragana table (romaji lowercase) */
const HIRAGANA = [
  ['a','ã‚'],['i','ã„'],['u','ã†'],['e','ãˆ'],['o','ãŠ'],
  ['ka','ã‹'],['ki','ã'],['ku','ã'],['ke','ã‘'],['ko','ã“'],
  ['sa','ã•'],['shi','ã—'],['su','ã™'],['se','ã›'],['so','ã'],
  ['ta','ãŸ'],['chi','ã¡'],['tsu','ã¤'],['te','ã¦'],['to','ã¨'],
  ['na','ãª'],['ni','ã«'],['nu','ã¬'],['ne','ã­'],['no','ã®'],
  ['ha','ã¯'],['hi','ã²'],['fu','ãµ'],['he','ã¸'],['ho','ã»'],
  ['ma','ã¾'],['mi','ã¿'],['mu','ã‚€'],['me','ã‚'],['mo','ã‚‚'],
  ['ya','ã‚„'],['yu','ã‚†'],['yo','ã‚ˆ'],
  ['ra','ã‚‰'],['ri','ã‚Š'],['ru','ã‚‹'],['re','ã‚Œ'],['ro','ã‚'],
  ['wa','ã‚'],['wo','ã‚’'],['n','ã‚“']
];

/* Katakana (same romaji map) */
const KATAKANA = HIRAGANA.map(([r,k])=>{
  // convert hiragana to katakana by unicode offset (simple method where applicable)
  const hira = k;
  let kata = '';
  for (let ch of hira){
    const code = ch.charCodeAt(0);
    if (code >= 0x3041 && code <= 0x3096) kata += String.fromCharCode(code + 0x60);
    else kata += ch;
  }
  return [r, kata];
});

/* Vocab list (Japanese, romaji, english) â€” a medium-sized built-in set.
   You can expand it later; quiz picks 100 unique questions from this list.
*/
const VOCAB = [
  /* 120+ entries to give the quiz variety */
  {jp:'ã“ã‚“ã«ã¡ã¯', rom:'konnichiwa', en:'hello'},
  {jp:'ã‚ã‚ŠãŒã¨ã†', rom:'arigatou', en:'thank you'},
  {jp:'ãŠé¡˜ã„ã—ã¾ã™', rom:'onegai shimasu', en:'please'},
  {jp:'ã¯ã„', rom:'hai', en:'yes'},
  {jp:'ã„ã„ãˆ', rom:'iie', en:'no'},
  {jp:'ã•ã‚ˆã†ãªã‚‰', rom:'sayounara', en:'goodbye'},
  {jp:'ãŠã¯ã‚ˆã†', rom:'ohayou', en:'good morning'},
  {jp:'ã“ã‚“ã°ã‚“ã¯', rom:'konbanwa', en:'good evening'},
  {jp:'ã”ã‚ã‚“ãªã•ã„', rom:'gomen nasai', en:'sorry'},
  {jp:'ã™ã¿ã¾ã›ã‚“', rom:'sumimasen', en:'excuse me'},
  {jp:'æ°´', rom:'mizu', en:'water'},
  {jp:'ãŠèŒ¶', rom:'ocha', en:'tea'},
  {jp:'ã”é£¯', rom:'gohan', en:'rice; meal'},
  {jp:'ãƒ‘ãƒ³', rom:'pan', en:'bread'},
  {jp:'è‚‰', rom:'niku', en:'meat'},
  {jp:'é­š', rom:'sakana', en:'fish'},
  {jp:'é‡Žèœ', rom:'yasai', en:'vegetable'},
  {jp:'æžœç‰©', rom:'kudamono', en:'fruit'},
  {jp:'åº—', rom:'mise', en:'shop; store'},
  {jp:'å­¦æ ¡', rom:'gakkou', en:'school'},
  {jp:'å…ˆç”Ÿ', rom:'sensei', en:'teacher'},
  {jp:'å­¦ç”Ÿ', rom:'gakusei', en:'student'},
  {jp:'å‹é”', rom:'tomodachi', en:'friend'},
  {jp:'å®¶', rom:'ie', en:'house'},
  {jp:'éƒ¨å±‹', rom:'heya', en:'room'},
  {jp:'è»Š', rom:'kuruma', en:'car'},
  {jp:'é§…', rom:'eki', en:'station'},
  {jp:'é“', rom:'michi', en:'road; way'},
  {jp:'æ©‹', rom:'hashi', en:'bridge'},
  {jp:'åº—å“¡', rom:'tenin', en:'clerk'},
  {jp:'ç—…é™¢', rom:'byouin', en:'hospital'},
  {jp:'è–¬', rom:'kusuri', en:'medicine'},
  {jp:'æ™‚é–“', rom:'jikan', en:'time'},
  {jp:'ä»Šæ—¥', rom:'kyou', en:'today'},
  {jp:'æ˜Žæ—¥', rom:'ashita', en:'tomorrow'},
  {jp:'æ˜¨æ—¥', rom:'kinou', en:'yesterday'},
  {jp:'æœ', rom:'asa', en:'morning'},
  {jp:'å¤œ', rom:'yoru', en:'night'},
  {jp:'ä»Š', rom:'ima', en:'now'},
  {jp:'å¹´', rom:'toshi', en:'year'},
  {jp:'æœˆ', rom:'tsuki', en:'month; moon'},
  {jp:'æ—¥', rom:'hi / nichi', en:'day; sun'},
  {jp:'åˆ†', rom:'fun', en:'minute'},
  {jp:'äºº', rom:'hito', en:'person'},
  {jp:'åå‰', rom:'namae', en:'name'},
  {jp:'é›»è©±', rom:'denwa', en:'telephone'},
  {jp:'ä½æ‰€', rom:'juusho', en:'address'},
  {jp:'å›½', rom:'kuni', en:'country'},
  {jp:'æ—¥æœ¬', rom:'nihon / nippon', en:'Japan'},
  {jp:'è‹±èªž', rom:'eigo', en:'English (language)'},
  {jp:'æ—¥æœ¬èªž', rom:'nihongo', en:'Japanese (language)'},
  {jp:'èª­ã‚€', rom:'yomu', en:'to read'},
  {jp:'æ›¸ã', rom:'kaku', en:'to write'},
  {jp:'èžã', rom:'kiku', en:'to listen; ask'},
  {jp:'è©±ã™', rom:'hanasu', en:'to speak'},
  {jp:'é£Ÿã¹ã‚‹', rom:'taberu', en:'to eat'},
  {jp:'é£²ã‚€', rom:'nomu', en:'to drink'},
  {jp:'è¦‹ã‚‹', rom:'miru', en:'to see'},
  {jp:'è¡Œã', rom:'iku', en:'to go'},
  {jp:'æ¥ã‚‹', rom:'kuru', en:'to come'},
  {jp:'è²·ã†', rom:'kau', en:'to buy'},
  {jp:'å£²ã‚‹', rom:'uru', en:'to sell'},
  {jp:'ä½¿ã†', rom:'tsukau', en:'to use'},
  {jp:'ä½œã‚‹', rom:'tsukuru', en:'to make'},
  {jp:'é–‹ã‘ã‚‹', rom:'akeru', en:'to open'},
  {jp:'é–‰ã‚ã‚‹', rom:'shimeru', en:'to close'},
  {jp:'å…¥ã‚‹', rom:'hairu', en:'to enter'},
  {jp:'å‡ºã‚‹', rom:'deru', en:'to exit'},
  {jp:'ç«‹ã¤', rom:'tatsu', en:'to stand'},
  {jp:'åº§ã‚‹', rom:'suwaru', en:'to sit'},
  {jp:'æ­©ã', rom:'aruku', en:'to walk'},
  {jp:'èµ°ã‚‹', rom:'hashiru', en:'to run'},
  {jp:'è²·ã„ç‰©', rom:'kaimono', en:'shopping'},
  {jp:'æ—…è¡Œ', rom:'ryokou', en:'travel'},
  {jp:'ç©ºæ¸¯', rom:'kuukou', en:'airport'},
  {jp:'å¤©æ°—', rom:'tenki', en:'weather'},
  {jp:'é›¨', rom:'ame', en:'rain'},
  {jp:'é›ª', rom:'yuki', en:'snow'},
  {jp:'é¢¨', rom:'kaze', en:'wind'},
  {jp:'æš‘ã„', rom:'atsui', en:'hot'},
  {jp:'å¯’ã„', rom:'samui', en:'cold'},
  {jp:'é«˜ã„', rom:'takai', en:'expensive; tall'},
  {jp:'å®‰ã„', rom:'yasui', en:'cheap'},
  {jp:'æ–°ã—ã„', rom:'atarashii', en:'new'},
  {jp:'å¤ã„', rom:'furui', en:'old'},
  {jp:'å¤§ãã„', rom:'ookii', en:'big'},
  {jp:'å°ã•ã„', rom:'chiisai', en:'small'},
  {jp:'é•·ã„', rom:'nagai', en:'long'},
  {jp:'çŸ­ã„', rom:'mijikai', en:'short'},
  {jp:'é€Ÿã„', rom:'hayai', en:'fast'},
  {jp:'é…ã„', rom:'osoi', en:'slow'},
  {jp:'å¼·ã„', rom:'tsuyoi', en:'strong'},
  {jp:'å¼±ã„', rom:'yowai', en:'weak'},
  {jp:'å¥½ã', rom:'suki', en:'like'},
  {jp:'å«Œã„', rom:'kirai', en:'dislike'},
  {jp:'æ¥½ã—ã„', rom:'tanoshii', en:'fun'},
  {jp:'æ‚²ã—ã„', rom:'kanashii', en:'sad'},
  {jp:'å¿™ã—ã„', rom:'isogashii', en:'busy'},
  {jp:'æš‡', rom:'hima', en:'free (time)'},
  {jp:'æ˜ ç”»', rom:'eiga', en:'movie'},
  {jp:'éŸ³æ¥½', rom:'ongaku', en:'music'},
  {jp:'æœ¬', rom:'hon', en:'book'},
  {jp:'åº—', rom:'mise', en:'shop'},
  {jp:'è²¡å¸ƒ', rom:'saifu', en:'wallet'},
  {jp:'éµ', rom:'kagi', en:'key'},
  {jp:'æ™‚è¨ˆ', rom:'tokei', en:'watch; clock'},
  {jp:'å†™çœŸ', rom:'shashin', en:'photo'},
  {jp:'å•é¡Œ', rom:'mondai', en:'problem; question'},
  {jp:'ç­”ãˆ', rom:'kotae', en:'answer'},
  {jp:'ç†ç”±', rom:'riyuu', en:'reason'}
];

/* ---------- utility helpers ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* speech (use browser TTS) */
function speak(text, lang='ja-JP'){
  if(!window.speechSynthesis) return;
  const ut = new SpeechSynthesisUtterance(text);
  ut.lang = lang;
  // try to pick Japanese voice if available
  window.speechSynthesis.getVoices(); // warm up
  setTimeout(()=> {
    const voices = window.speechSynthesis.getVoices();
    const v = voices.find(x=>x.lang && x.lang.startsWith('ja')) || voices[0];
    if(v) ut.voice = v;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ut);
  }, 0);
}

/* ---------- render kana grid ---------- */
let currentChart = 'hira'; // 'hira' | 'kata' | 'vocab'
const kanaGrid = $('#kanaGrid');
const vocabListEl = $('#vocabList');
const vocabCard = $('#vocabCard');

function renderKana(filter=''){
  kanaGrid.innerHTML = '';
  const data = currentChart === 'hira' ? HIRAGANA : KATAKANA;
  const q = filter.trim().toLowerCase();
  const filtered = data.filter(([r, k]) => {
    if(!q) return true;
    return r.includes(q) || k.includes(q) || r.startsWith(q);
  });
  // render grid (cap at 50 results to avoid too many)
  filtered.slice(0, 100).forEach(([romaji, kana])=>{
    const d = document.createElement('div');
    d.className = 'kana';
    d.innerHTML = `<div class="char">${kana}</div><div class="rom">${romaji}</div>`;
    d.addEventListener('click', ()=> speak(kana));
    kanaGrid.appendChild(d);
  });
}

/* render vocab list */
function renderVocab(filter=''){
  vocabListEl.innerHTML = '';
  const q = filter.trim().toLowerCase();
  const filtered = VOCAB.filter(v => {
    if(!q) return true;
    return v.jp.includes(q) || v.rom.toLowerCase().includes(q) || v.en.toLowerCase().includes(q);
  });
  filtered.slice(0,200).forEach(v => {
    const card = document.createElement('div');
    card.style.background = 'linear-gradient(180deg,#fff,#fbfdff)';
    card.style.padding = '12px';
    card.style.borderRadius = '10px';
    card.style.border = '1px solid rgba(0,0,0,0.04)';
    card.style.cursor = 'pointer';
    card.innerHTML = `<div style="font-size:18px;font-weight:800">${v.jp}</div><div style="font-size:13px;color:var(--muted);margin-top:6px">${v.rom} â€” ${v.en}</div>`;
    card.addEventListener('click', ()=> speak(v.jp));
    vocabListEl.appendChild(card);
  });
}

/* ---------- search binding ---------- */
$('#search').addEventListener('input', e => {
  const v = e.target.value;
  if(currentChart === 'vocab'){
    renderVocab(v);
  } else {
    renderKana(v);
  }
});

/* ---------- chart switch buttons ---------- */
$('#btnHira').addEventListener('click', ()=> {
  currentChart = 'hira'; $('#vocabCard').style.display='none'; $('#quizCard').style.display='none';
  $('#chartsWrap').style.display='block'; renderKana($('#search').value||'');
});
$('#btnKata').addEventListener('click', ()=> {
  currentChart = 'kata'; $('#vocabCard').style.display='none'; $('#quizCard').style.display='none';
  $('#chartsWrap').style.display='block'; renderKana($('#search').value||'');
});
$('#btnVocab').addEventListener('click', ()=> {
  currentChart = 'vocab'; $('#chartsWrap').style.display='none'; $('#quizCard').style.display='none';
  $('#vocabCard').style.display='block'; renderVocab($('#search').value||'');
});
$('#btnQuiz').addEventListener('click', ()=> {
  currentChart = 'quiz'; $('#chartsWrap').style.display='none'; $('#vocabCard').style.display='none';
  $('#quizCard').style.display='block';
});

/* initial render */
renderKana();
$('#year').textContent = new Date().getFullYear();

/* ---------- sidebar open/close ---------- */
const sidebar = $('#sidebar'), hambBtn = $('#hambBtn'), closeSidebar = $('#closeSidebar');
function openSidebar(){ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); closeSidebar.focus(); }
function closeSB(){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); }
hambBtn.addEventListener('click', openSidebar);
closeSidebar.addEventListener('click', closeSB);
document.addEventListener('keydown', e => { if(e.key === 'Escape') closeSB(); });
document.addEventListener('click', e => {
  if(!sidebar.classList.contains('open')) return;
  if(!sidebar.contains(e.target) && !hambBtn.contains(e.target)) closeSB();
});

/* jumpTop / quick actions */
$('#jumpTop').addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));
$('#showVocab').addEventListener('click', ()=> { $('#btnVocab').click(); window.scrollTo({top:document.querySelector('#vocabCard').offsetTop-20, behavior:'smooth'}); });
$('#showQuiz').addEventListener('click', ()=> { $('#btnQuiz').click(); window.scrollTo({top:document.querySelector('#quizCard').offsetTop-20, behavior:'smooth'}); });

/* theme picker */
const themeBtn = $('#themeBtn'), themeList = document.getElementById('themeList');
themeBtn.addEventListener('click', () => { themeList.style.display = themeList.style.display === 'block' ? 'none' : 'block'; });
themeList.addEventListener('click', e => {
  const t = e.target.closest('.theme-item'); if(!t) return;
  const theme = t.dataset.theme;
  document.documentElement.classList.remove('dark','ocean','sunset');
  if(theme === 'dark') document.documentElement.classList.add('dark');
  else if(theme === 'ocean') document.documentElement.classList.add('ocean');
  else if(theme === 'sunset') document.documentElement.classList.add('sunset');
  themeBtn.textContent = (theme === 'dark' ? 'Dark â–¾' : theme === 'ocean' ? 'Ocean â–¾' : theme === 'sunset' ? 'Sunset â–¾' : 'Light â–¾');
  localStorage.setItem('site-theme', theme);
  themeList.style.display = 'none';
});
const saved = localStorage.getItem('site-theme'); if(saved) { document.documentElement.classList.add(saved==='dark'?'dark':saved==='ocean'?'ocean':saved==='sunset'?'sunset':''); themeBtn.textContent = (saved==='dark'?'Dark â–¾':saved==='ocean'?'Ocean â–¾':saved==='sunset'?'Sunset â–¾':'Light â–¾'); }

/* ---------- Quiz logic (100 questions) ---------- */
const startQuizBtn = $('#startQuiz');
const cancelQuiz = $('#cancelQuiz');
const quizIntro = $('#quizIntro');
const quizUI = $('#quizUI');
const quizSummary = $('#quizSummary');
const questionText = $('#questionText');
const choicesWrap = $('#choicesWrap');
const qProgress = $('#qProgress');
const qScore = $('#qScore');
const nextQ = $('#nextQ');
const endQuiz = $('#endQuiz');

let quizDeck = []; // array of {vocab, correctIndex, choices: []}
let currentQ = 0;
let score = 0;
let answered = false;

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

function buildQuizDeck(){
  const pool = [...VOCAB];
  if(pool.length < 100){
    // if not enough items, duplicate with small variations (should not happen often)
    while(pool.length < 120) pool.push(...VOCAB);
  }
  pool.length = pool.length; // ensure array
  shuffle(pool);
  const deck = [];
  const used = new Set();
  let i = 0;
  while(deck.length < 100 && i < pool.length){
    const v = pool[i++];
    if(used.has(v.jp)) continue;
    used.add(v.jp);
    // build 3 distractors
    const others = VOCAB.filter(x=>x.jp !== v.jp);
    shuffle(others);
    const choices = [v.en, others[0].en, others[1].en, others[2].en];
    shuffle(choices);
    deck.push({vocab:v, choices, correct: choices.indexOf(v.en)});
  }
  return deck;
}

function showQuestion(){
  answered = false; nextQ.style.display = 'none';
  const item = quizDeck[currentQ];
  questionText.textContent = `Q${currentQ+1}: ${item.vocab.jp}  â€”  (${item.vocab.rom})`;
  choicesWrap.innerHTML = '';
  item.choices.forEach((c, idx) => {
    const btn = document.createElement('div');
    btn.className = 'choice';
    btn.textContent = c;
    btn.addEventListener('click', () => {
      if(answered) return;
      answered = true;
      if(idx === item.correct){
        btn.classList.add('correct'); score++;
        qScore.textContent = `Score: ${score}`;
      } else {
        btn.classList.add('wrong');
        // highlight correct
        const correctEl = Array.from(choicesWrap.children)[item.correct];
        if(correctEl) correctEl.classList.add('correct');
      }
      nextQ.style.display = (currentQ < quizDeck.length-1) ? 'inline-block' : 'none';
      if(currentQ === quizDeck.length-1) endQuiz.style.display='inline-block';
    });
    choicesWrap.appendChild(btn);
  });
  qProgress.textContent = `Q ${currentQ+1} / ${quizDeck.length}`;
  // auto play audio for the japanese
  speak(item.vocab.jp);
}

startQuizBtn.addEventListener('click', ()=>{
  quizDeck = buildQuizDeck();
  currentQ = 0; score = 0;
  $('#quizIntro').style.display = 'none';
  quizUI.style.display = 'block';
  $('#quizSummary').style.display = 'none';
  qScore.textContent = `Score: ${score}`;
  showQuestion();
});

cancelQuiz.addEventListener('click', ()=> {
  $('#quizIntro').style.display = 'block';
  quizUI.style.display = 'none';
});

nextQ.addEventListener('click', ()=>{
  if(!answered) return;
  currentQ++;
  if(currentQ >= quizDeck.length){ finishQuiz(); return; }
  showQuestion();
});

endQuiz.addEventListener('click', finishQuiz);

function finishQuiz(){
  quizUI.style.display = 'none';
  quizSummary.style.display = 'block';
  quizSummary.innerHTML = `<div style="font-weight:900">Quiz complete</div>
    <div style="margin-top:8px">Score: <strong>${score} / ${quizDeck.length}</strong></div>
    <div style="margin-top:8px">${Math.round((score/quizDeck.length)*100)}% correct</div>
    <div style="margin-top:12px"><button class="btn theme" id="retry">Retry</button> <button class="btn ghost" id="backToStart">Back</button></div>`;
  $('#retry').addEventListener('click', ()=> { $('#quizIntro').style.display='none'; quizUI.style.display='block'; quizSummary.style.display='none'; startQuizBtn.click(); });
  $('#backToStart').addEventListener('click', ()=> { $('#quizIntro').style.display='block'; quizSummary.style.display='none'; quizUI.style.display='none'; });
}

/* ---------- interactions: initial states ---------- */
$('#btnHira').click(); // default
$('#vocabCard').style.display = 'none';
$('#quizCard').style.display = 'none';

/* show vocab when user clicks link-like text */
$$('.linkish').forEach(el=>el.addEventListener('click', ()=>$('#btnVocab').click()));

/* make sure clicking a vocab/search shows appropriate */
$('#search').addEventListener('keydown', e => { if(e.key === 'Enter'){ if(currentChart !== 'vocab') { $('#btnVocab').click(); } renderVocab($('#search').value); } });

/* make visit button in footer clickable (already anchor) */

/* small responsiveness for sidebar width */
function updateSidebarWidth(){ if(window.innerWidth < 420) sidebar.style.width = '94vw'; else sidebar.style.width = '360px'; }
window.addEventListener('resize', updateSidebarWidth);
updateSidebarWidth();

/* ensure voices warmed up */
if(window.speechSynthesis) window.speechSynthesis.getVoices();
</script>
</body>
</html>
